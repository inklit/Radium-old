-- startup
-- Run on startup, performs TLCO and then runs bootloader

local bootFile = ".system/boot.lua"
local recoveryFile = ".system/recovery.lua"

if not _TLCO then
	_G._TLCO = true
	local _pe = _G.printError
	function _G.printError()
		_G.printError = _pe
		local ok, err = pcall(assert(loadfile(bootFile)))
		if not ok then
			local ok, err2 = pcall(function()
				local recovery = loadfile(recoveryFile)
				recovery(err)
			end)
			if not ok then
				printError("Fatal error; recovery unavailable. Shutting down in 5 seconds!")
				sleep(5)
			end
			os.shutdown()
		end
	end
	os.queueEvent("terminate")
end